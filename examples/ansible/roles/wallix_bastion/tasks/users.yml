---
# wallix_bastion role - user management tasks

- name: Get existing users
  ansible.builtin.uri:
    url: "{{ wallix_base_url }}/users?limit=1000"
    method: GET
    headers:
      Authorization: "{{ wallix_auth_header }}"
      Content-Type: "application/json"
    validate_certs: "{{ wallix_verify_ssl }}"
    timeout: "{{ wallix_timeout }}"
  register: existing_users
  when: wallix_get_existing | default(true)

- name: Build existing users lookup
  ansible.builtin.set_fact:
    existing_user_names: "{{ existing_users.json.data | default([]) | map(attribute='user_name') | list }}"
  when: existing_users is defined

- name: Create users
  ansible.builtin.uri:
    url: "{{ wallix_base_url }}/users"
    method: POST
    headers:
      Authorization: "{{ wallix_auth_header }}"
      Content-Type: "application/json"
    body_format: json
    body:
      user_name: "{{ item.user_name }}"
      display_name: "{{ item.display_name | default(item.user_name) }}"
      email: "{{ item.email }}"
      profile: "{{ item.profile | default('user') }}"
      groups: "{{ item.groups | default([]) }}"
      ip_source: "{{ item.ip_source | default('') }}"
      preferred_language: "{{ item.language | default('en') }}"
      force_change_pwd: "{{ item.force_change_pwd | default(false) }}"
    validate_certs: "{{ wallix_verify_ssl }}"
    timeout: "{{ wallix_timeout }}"
    status_code: [200, 201]
  loop: "{{ wallix_users }}"
  when:
    - wallix_users is defined
    - item.user_name not in (existing_user_names | default([]))
    - not (wallix_check_mode | default(false))
  register: created_users
  retries: "{{ wallix_retries }}"
  delay: "{{ wallix_retry_delay }}"
  until: created_users is not failed
  ignore_errors: "{{ wallix_ignore_errors | default(false) }}"

- name: Update existing users
  ansible.builtin.uri:
    url: "{{ wallix_base_url }}/users/{{ item.user_name }}"
    method: PUT
    headers:
      Authorization: "{{ wallix_auth_header }}"
      Content-Type: "application/json"
    body_format: json
    body:
      display_name: "{{ item.display_name | default(item.user_name) }}"
      email: "{{ item.email }}"
      groups: "{{ item.groups | default([]) }}"
    validate_certs: "{{ wallix_verify_ssl }}"
    timeout: "{{ wallix_timeout }}"
    status_code: [200, 204]
  loop: "{{ wallix_users }}"
  when:
    - wallix_users is defined
    - wallix_update_existing | default(false)
    - item.user_name in (existing_user_names | default([]))
    - not (wallix_check_mode | default(false))
  register: updated_users
  ignore_errors: "{{ wallix_ignore_errors | default(false) }}"

- name: Add users to groups
  ansible.builtin.uri:
    url: "{{ wallix_base_url }}/usergroups/{{ item.1 }}/users/{{ item.0.user_name }}"
    method: POST
    headers:
      Authorization: "{{ wallix_auth_header }}"
      Content-Type: "application/json"
    validate_certs: "{{ wallix_verify_ssl }}"
    timeout: "{{ wallix_timeout }}"
    status_code: [200, 201, 204, 409]  # 409 = already member
  loop: "{{ wallix_users | subelements('groups', skip_missing=True) }}"
  when:
    - wallix_users is defined
    - not (wallix_check_mode | default(false))
  ignore_errors: "{{ wallix_ignore_errors | default(false) }}"

- name: Disable users
  ansible.builtin.uri:
    url: "{{ wallix_base_url }}/users/{{ item }}"
    method: PUT
    headers:
      Authorization: "{{ wallix_auth_header }}"
      Content-Type: "application/json"
    body_format: json
    body:
      is_disabled: true
    validate_certs: "{{ wallix_verify_ssl }}"
    timeout: "{{ wallix_timeout }}"
    status_code: [200, 204]
  loop: "{{ wallix_users_to_disable | default([]) }}"
  when:
    - wallix_users_to_disable is defined
    - not (wallix_check_mode | default(false))
  ignore_errors: "{{ wallix_ignore_errors | default(false) }}"

- name: Delete users
  ansible.builtin.uri:
    url: "{{ wallix_base_url }}/users/{{ item }}"
    method: DELETE
    headers:
      Authorization: "{{ wallix_auth_header }}"
    validate_certs: "{{ wallix_verify_ssl }}"
    timeout: "{{ wallix_timeout }}"
    status_code: [200, 204, 404]
  loop: "{{ wallix_users_to_delete | default([]) }}"
  when:
    - wallix_users_to_delete is defined
    - not (wallix_check_mode | default(false))
  ignore_errors: "{{ wallix_ignore_errors | default(false) }}"
